# 红单(PushOrder)功能完整架构分析 - 工程模块版

## 概览

红单功能跨越**两个核心工程模块**，总计**9个Controller**，**75个接口**。

```
┌─────────────────────────────────────────────────────────────────┐
│                   红单(PushOrder)功能总体架构                    │
├──────────────────────────────────────┬──────────────────────────┤
│      dc-api-friend (核心服务层)      │   dc-api-office(后台管理) │
│                                      │                           │
│  2 Controllers, 24 接口              │   7 Controllers, 51 接口  │
│  ─────────────────────────────────   │  ──────────────────────  │
│  • PushOrderExternalController (19)  │  • PushOrderAiUser (16)   │
│    - 外部API                         │  • PushOrderContentMgmt(13)
│    - APP端接口                       │  • PushOrderLevelTitle(5) │
│                                      │  • PushOrderParamConfig(4)│
│  • PushOrderInsideController (5)     │  • PushOrderPublic (8)    │
│    - WebService内部调用              │  • ContentGeneralLog (3)  │
│    - 财务系统集成                    │  • PermissionRecord (2)   │
│                                      │                           │
└──────────────────────────────────────┴──────────────────────────┘
```

---

## 一、dc-api-friend (客户端服务层)

**定位**: 用户侧API，负责APP展示、查询、购买等外部接口

### 1.1 PushOrderExternalController (19 接口)

**路径**: `/api/friend/pushOrder/external/*`

**功能类型**:
- **排行榜展示** (5)：月榜、人气榜、连红榜
- **个人信息查询** (3)：称号查询、排名查询、粉丝查询
- **内容浏览** (4)：推单详情、相关推单、评论查看
- **用户交互** (4)：关注、点赞、举报、分享
- **数据查询** (3)：个人战绩、收藏、购买记录

**核心接口**:

```
POST /1.0/findPersonalInfoPageList         # APP个人信息(根据称号查询)
POST /1.0/findMonthlyRankingFirstList      # APP首页月榜
POST /1.0/findMonthlyRankingPageList       # APP月榜分页(红单榜/连红榜/人气榜)
POST /1.0/findMyAttentionPageList          # APP我关注的推手
POST /1.0/selectPushOrderDetail            # 查询推单详情
POST /1.0/selectRecommendPushOrder         # 查询相关推单推荐
POST /1.0/selectCommentsList               # 查询评论列表
POST /1.0/selectUserCommentsList           # 查询用户的评论
POST /1.0/addGrade                         # 添加点赞/取消点赞
POST /1.0/addFollow                        # 添加关注
POST /1.0/queryFollowStatus                # 查询关注状态
POST /1.0/addComplaint                     # 添加举报
POST /1.0/addPushOrderShare                # 添加分享记录
POST /1.0/selectUserWinRecords             # 查询用户战绩(中奖记录)
POST /1.0/selectUserCollectionList         # 查询用户收藏推单
POST /1.0/selectPurchaseRecordList         # 查询购买记录
POST /1.0/purchasePushOrder                # 购买推单
POST /1.0/queryUserLevelTitle              # 查询用户称号
POST /1.0/queryFansCount                   # 查询粉丝数
```

**使用者**: APP客户端、小程序、H5

---

### 1.2 PushOrderInsideController (5 接口)

**路径**: `/api/friend/pushOrder/inside/*`

**功能类型**:
- **财务系统集成** (5)：费用查询、支付结算、订单确认

**核心接口**:

```
POST /1.0/findPurchasePushOrderInfo        # WebService获取购买推单信息
POST /1.0/purchasePlanReceive              # WebService购买推单(支付确认)
POST /1.0/queryPushOrderStatistics         # WebService查询推单统计
POST /1.0/confirmPaymentOrder              # WebService确认支付单
POST /1.0/syncOrderToFinance               # WebService同步订单到财务
```

**使用者**: 财务系统、内部WebService调用、订单服务

---

## 二、dc-api-office (后台管理层)

**定位**: 运营/管理侧API，负责推单生成、发布、审核等后台管理

### 2.1 PushOrderAiUserController (16 接口)

**功能**: AI推手用户管理

```
POST /pushOrderAiUser/add                  # 新增AI推手用户
POST /pushOrderAiUser/edit                 # 编辑AI推手用户
POST /pushOrderAiUser/delete               # 删除AI推手用户
POST /pushOrderAiUser/queryById            # 查询AI推手用户详情
POST /pushOrderAiUser/queryList            # 查询AI推手用户列表
POST /pushOrderAiUser/queryByPage          # 分页查询AI推手用户
POST /pushOrderAiUser/queryByCopywrite     # 查询推手对应的文案
POST /pushOrderAiUser/updateCopywrite      # 更新推手文案
POST /pushOrderAiUser/queryAIStatus        # 查询AI运行状态
POST /pushOrderAiUser/startAI              # 启动AI
POST /pushOrderAiUser/stopAI               # 停止AI
POST /pushOrderAiUser/resetAI              # 重置AI
POST /pushOrderAiUser/queryAILogs          # 查询AI执行日志
POST /pushOrderAiUser/exportAIUser         # 导出AI用户列表
POST /pushOrderAiUser/importAIUser         # 导入AI用户列表
POST /pushOrderAiUser/checkAIHealth        # 检查AI健康状态
```

**权限**: 后台管理员

---

### 2.2 PushOrderContentManagementController (13 接口)

**功能**: 推单内容管理(生成、审核、发布)

```
POST /pushOrderContent/generateContent     # 生成推单内容
POST /pushOrderContent/previewContent      # 预览生成的内容
POST /pushOrderContent/editContent         # 编辑内容
POST /pushOrderContent/deleteContent       # 删除内容
POST /pushOrderContent/publishContent      # 发布内容
POST /pushOrderContent/withdrawContent     # 撤回已发布内容
POST /pushOrderContent/queryById           # 查询内容详情
POST /pushOrderContent/queryByPage         # 分页查询内容
POST /pushOrderContent/queryDraftList      # 查询草稿列表
POST /pushOrderContent/queryPublishList    # 查询已发布列表
POST /pushOrderContent/auditContent        # 审核内容
POST /pushOrderContent/batchPublish        # 批量发布
POST /pushOrderContent/queryContentStats   # 查询内容统计数据
```

**权限**: 内容编辑、审核员

---

### 2.3 PushOrderPublicController (8 接口)

**功能**: 公开展示接口(供第三方/客户端使用)

```
POST /pushOrderPublic/queryHotList         # 查询热门推单列表
POST /pushOrderPublic/queryLatestList      # 查询最新推单列表
POST /pushOrderPublic/queryByCategory      # 按类别查询推单
POST /pushOrderPublic/queryDetail          # 查询推单详情
POST /pushOrderPublic/queryComments        # 查询评论
POST /pushOrderPublic/searchPushOrder      # 搜索推单
POST /pushOrderPublic/queryTrendAnalysis   # 查询趋势分析
POST /pushOrderPublic/queryRanking         # 查询排名数据
```

**权限**: 无(公开接口)

---

### 2.4 PushOrderLevelTitleConfigController (5 接口)

**功能**: 推手等级及称号配置

```
POST /levelTitleConfig/add                 # 新增等级配置
POST /levelTitleConfig/edit                # 编辑等级配置
POST /levelTitleConfig/delete              # 删除等级配置
POST /levelTitleConfig/queryList           # 查询等级配置列表
POST /levelTitleConfig/queryById           # 查询等级配置详情
```

**权限**: 系统管理员

---

### 2.5 PushOrderParamConfigController (4 接口)

**功能**: 系统参数配置

```
POST /paramConfig/update                   # 更新参数配置
POST /paramConfig/query                    # 查询参数配置
POST /paramConfig/queryByKey               # 按Key查询参数
POST /paramConfig/batchUpdate              # 批量更新参数
```

**权限**: 系统管理员

---

### 2.6 PushOrderContentGeneralLogController (3 接口)

**功能**: 内容生成日志查询

```
POST /contentLog/queryList                 # 查询内容生成日志
POST /contentLog/queryById                 # 查询日志详情
POST /contentLog/exportLogs                # 导出日志
```

**权限**: 管理员

---

### 2.7 PushOrderPermissionRecordController (2 接口)

**功能**: 权限记录追踪

```
POST /permissionRecord/queryList           # 查询权限记录
POST /permissionRecord/queryUserPermissions# 查询用户权限
```

**权限**: 管理员

---

## 三、业务流程与工程对应

```
┌──────────────────────────────────────────────────────────────┐
│             推单生命周期与工程模块对应                        │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  1. 配置阶段 [dc-api-office]                                 │
│     └─ 配置等级、参数 → PushOrderLevelTitleConfig            │
│                         PushOrderParamConfig                 │
│                                                              │
│  2. 生成阶段 [dc-api-office]                                 │
│     └─ 启动AI生成 → PushOrderAiUser.startAI                 │
│     └─ 生成内容 → PushOrderContentManagement.generateContent│
│                                                              │
│  3. 审核阶段 [dc-api-office]                                 │
│     └─ 审核内容 → PushOrderContentManagement.auditContent   │
│     └─ 记录审核 → PushOrderPermissionRecord                 │
│                                                              │
│  4. 发布阶段 [dc-api-office]                                 │
│     └─ 发布内容 → PushOrderContentManagement.publishContent │
│     └─ 生成日志 → PushOrderContentGeneralLog                │
│                                                              │
│  5. 展示阶段 [dc-api-office]                                 │
│     └─ 公开查询 → PushOrderPublic                           │
│                                                              │
│  6. 交互阶段 [dc-api-friend]                                 │
│     └─ 用户查看 → PushOrderExternalController               │
│     └─ 用户购买 → PushOrderExternalController               │
│     └─ 财务确认 → PushOrderInsideController                 │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

---

## 四、数据流与调用关系

```
┌─────────────────────────────────────────────────────────────────┐
│                    数据流向图                                    │
├──────────────────────────────────────┬──────────────────────────┤
│                                      │                           │
│  dc-api-office (后台系统)            │  dc-api-friend (用户系统) │
│  ════════════════════════════════    │  ═══════════════════════ │
│                                      │                           │
│  1. 配置参数                         │                           │
│     └─ ParamConfig                   │                           │
│                                      │                           │
│  2. 启动AI用户                       │                           │
│     └─ AiUser.startAI()              │                           │
│           │                          │                           │
│           ├─ 生成推单内容            │                           │
│           │  └─ ContentMgmt.generate │                           │
│           │                          │                           │
│           └─ 保存到数据库            │                           │
│                                      │                           │
│  3. 审核与发布                       │                           │
│     └─ ContentMgmt.publish()          │                           │
│           │                          │                           │
│           └─ 更新推单状态:发布       │                           │
│                                      │                           │
│                       ↓ (数据同步)   │                           │
│                                      │                           │
│                                      │  4. 用户查询              │
│                                      │     └─ External.query     │
│                                      │        内容、排行、详情   │
│                                      │                           │
│                                      │  5. 用户购买              │
│                                      │     └─ External.purchase()│
│                                      │           │               │
│                                      │           └─ 向财务系统   │
│                                      │              Inside.pay   │
│                                      │                           │
│                                      │  6. 支付确认              │
│                                      │     └─ Inside.confirm()   │
│                                      │                           │
│  7. 统计与分析                       │                           │
│     └─ GeneralLog记录                │                           │
│     └─ PublicController统计          │                           │
│                                      │                           │
└──────────────────────────────────────┴──────────────────────────┘
```

---

## 五、工程分工矩阵

| 维度 | dc-api-friend | dc-api-office |
|------|---------------|---------------|
| **定位** | 用户侧 | 运营侧 |
| **访问控制** | 需授权 + 公开 | 仅内部用户 |
| **功能** | 查询、购买 | 生成、审核、发布 |
| **Controllers** | 2个 | 7个 |
| **接口总数** | 24个 | 51个 |
| **核心能力** | 内容展示、用户交互 | 内容管理、AI生成 |
| **数据流** | 消费者 | 生产者 |
| **权限体系** | 用户权限 | 管理员权限 |
| **第三方对接** | ✓ (WebService) | ✗ |
| **客户端对接** | ✓ (APP) | ✗ |

---

## 六、部署架构

```
┌────────────────────────────────────────────────────────────────────┐
│                     部署架构(多模块)                               │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  ┌──────────────────────────────┐  ┌───────────────────────────┐ │
│  │   dc-api-friend              │  │   dc-api-office           │ │
│  │   (用户API服务)              │  │   (后台管理服务)          │ │
│  ├──────────────────────────────┤  ├───────────────────────────┤ │
│  │ Endpoints:                   │  │ Endpoints:                │ │
│  │ /api/friend/pushOrder/       │  │ /pushOrder*Controller     │ │
│  │ external/*                   │  │ /levelTitleConfig/*       │ │
│  │ inside/*                     │  │ /paramConfig/*            │ │
│  │                              │  │ /contentLog/*             │ │
│  │ 监听端口: 8081               │  │ 监听端口: 8082            │ │
│  └──────────────────────────────┘  └───────────────────────────┘ │
│          ↓                                   ↓                    │
│   ┌────────────────────────────────────────────────────────┐    │
│   │              共享数据库 (pngrd)                         │    │
│   │  - master_push_order_*                                 │    │
│   │  - master_user_*                                       │    │
│   └────────────────────────────────────────────────────────┘    │
│                                                                  │
└────────────────────────────────────────────────────────────────────┘
```

---

## 七、接口总结

| 类型 | 数量 | 工程 | 说明 |
|------|------|------|------|
| **外部API** (客户端) | 19 | dc-api-friend | 展示、购买、交互 |
| **内部WebService** | 5 | dc-api-friend | 财务、订单集成 |
| **后台管理** | 51 | dc-api-office | 生成、审核、发布、配置 |
| **合计** | **75** | **两个工程** | - |

---

## 八、要点总结

✓ **dc-api-friend** = 核心业务接口 (24)  
✓ **dc-api-office** = 后台管理接口 (51)  
✓ **前者是客户侧，后者是运营侧**  
✓ **前者消费内容，后者生产内容**  
✓ **两层清晰的架构：生产层 + 消费层**

---

*最后更新: 2025年1月29日*
