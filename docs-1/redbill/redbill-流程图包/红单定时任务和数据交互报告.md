# 红单（推单）后台定时任务、数据抓取及交互接口报告

## 一、定时任务概览

红单功能共有 **5个定时任务**，分布在 `AIPushOrderTask.java` 中，由 Quartz 框架定时触发。

---

## 二、详细定时任务说明

### 1️⃣ AI推单任务（aiPushOrder）
**任务类**：`AIPushOrderTask.aiPushOrder()`
**触发时间**：每天晚上 **21:00:00**（21点）
**Cron表达式**：`0 0 21 * * ?`
**对应方法**：`IAIPushOrderService.taskCreatePushOrder()`

**功能描述**：
- 根据未来2天内即将开赛的体育赛事生成单关推单
- 全AI模式推单
- 调用 `createPushOrder()` 方法，按系统配置的推单产品逐个生成推单
- 日志记录：`AI推单 定时任务【启动】/【结束】/【发生异常】`

**核心逻辑**：
```
1. 获取系统配置的推单产品列表
2. 针对每个产品：
   - 查询该产品下所有启用的AI推单用户
   - 获取对应赛事信息（未来2天内开赛）
   - 调用豆包AI或KIMI AI生成推单分析
   - 保存推单内容到数据库
```

---

### 2️⃣ AI补救推单任务（aiRepairPushOrder）
**任务类**：`AIPushOrderTask.aiRepairPushOrder()`
**触发时间**：每天晚上 **23:00:00**（23点）
**Cron表达式**：`0 0 23 * * ?`
**对应方法**：`IAIPushOrderService.taskRepairCreatePushOrder()`

**功能描述**：
- 保险机制：如果 21点推单任务失败，则进行补救
- 检查当日是否已生成推单
- 如果当日推单为空或失败，则重新执行推单逻辑
- 不重复生成已成功的推单

**核心逻辑**：
```
1. 查询当日AI生成的推单总数
2. 如果 count <= 0：
   - 执行补救推单（调用 createPushOrder()）
   - 日志：「补救推单已启动」
3. 如果 count > 0：
   - 跳过补救
   - 日志：「今日推单正常完成 N 单，无需补救」
```

---

### 3️⃣ AI补单任务（aiRestockPushOrder）
**任务类**：`AIPushOrderTask.aiRestockPushOrder()`
**触发时间**：每天凌晨 **00:00:01**（0点零1秒）
**Cron表达式**：`1 0 0 * * ?`
**对应方法**：`IAIPushOrderService.taskRestockPushOrder()`

**功能描述**：
- 为某些用户补充缺失的推单
- 针对设置了「联赛限制」的推单用户进行补单
- 处理流程复杂，涉及历史推单对比

**核心逻辑**：
```
1. 获取系统配置的推单产品
2. 针对每个产品：
   a) 查询设置了「针对联赛」的推单用户（onlyLeague=true）
   b) 从中提取设置的联赛ID列表
   c) 查询「2天前」针对该联赛已推过的赛事
   d) 查询「当日」特定联赛开赛但未推过的赛事
   e) 排除 odds 无效的赛事（odds为null或[]）
   f) 排除 odds 中盘口不足3个的赛事
   g) 对于2天前推过的用户，扣减其推单数量
   h) 执行补单逻辑
3. 返回本次补单成功总数
```

**重要参数**：
- `onlyLeague`：是否只针对特定联赛推单
- `leagueId`：针对的联赛ID
- `leagueName`：联赛名称
- `odds`：赛事赔率数据（需满足特定格式）

---

### 4️⃣ 月度用户火标志设置（userFire）
**任务类**：`AIPushOrderTask.userFire()`
**触发时间**：每月5号 **00:00:00**（0点）
**Cron表达式**：`1 0 0 5 * ?`
**对应方法**：`IMasterUserService.setUserFire()`

**功能描述**：
- 每月初重置推单用户的「火」标志
- 影响用户在月度排行榜中的展示

**使用场景**：
- 月度排行榜重置
- 用户等级/称号更新
- 推单人气值清零

---

### 5️⃣ 真实玩家推单任务（aiRealPushOrder）
**任务类**：`AIPushOrderTask.aiRealPushOrder()`
**触发时间**：每天晚上 **20:00:00**（20点）
**Cron表达式**：`0 0 20 * * ?`
**对应方法**：`IAIPushOrderService.taskCreateRealPushOrder()`

**功能描述**：
- 基于真实玩家注单数据生成推单
- 半AI模式推单（真实用户 + AI分析）
- 目的：提高推单的真实性和可信度

**核心逻辑**：
```
1. 查询系统配置的推单产品
2. 针对每个产品：
   - 查询设置为「半AI」(userType=1) 的推单用户
   - 基于其历史注单数据进行分析
   - 调用AI进行推荐分析
   - 生成真实推单内容
3. 保存推单到数据库
```

---

## 三、定时任务执行时间表

| 序号 | 任务名称 | 执行时间 | 触发间隔 | 优先级 |
|------|---------|---------|---------|--------|
| 1 | 真实玩家推单 | 20:00:00 | 每天 | 低 |
| 2 | AI推单 | 21:00:00 | 每天 | 高 |
| 3 | AI补救推单 | 23:00:00 | 每天 | 中 |
| 4 | AI补单 | 00:00:01 | 每天 | 中 |
| 5 | 月度用户火标志 | 每月5号 00:00:00 | 每月 | 低 |

**执行序列建议**：
```
20:00 → 真实推单准备
21:00 → 全AI推单执行 ← 主要业务
23:00 → 检查并补救
00:01 → 补充缺失推单
每月5日 → 用户数据重置
```

---

## 四、数据抓取及来源

### 4.1 赛事数据来源

#### 来源1：体育赛事库（SportMatchVO）
**数据表**：`push_order_content_management`（推单内容表）
**关键字段**：
- `match_id`：赛事ID
- `match_name`：赛事名称
- `league_id`：联赛ID
- `league_name`：联赛名称
- `match_start_time`：比赛开始时间
- `match_end_time`：比赛结束时间
- `odds`：赔率数据（JSON格式）
- `match_status`：比赛状态

**抓取逻辑**：
```java
// 查询2天内即将开赛的赛事
List<SportMatchVO> matches = pushOrderContentManagementDao.selectTodayRestockMatch(params);

// 参数说明
params.put("leagues", leagueIds);      // 筛选特定联赛
params.put("matchs", excludeMatchIds); // 排除已推过的赛事
```

#### 来源2：用户推单设置（PushOrderAiUser）
**数据表**：`push_order_ai_user`（推单AI用户表）
**关键字段**：
- `user_name`：推单用户名
- `user_type`：用户类型（0=全AI, 1=半AI）
- `product`：所属产品
- `league_id`：针对的联赛（可选）
- `league_name`：联赛名称（可选）
- `only_league`：是否仅针对特定联赛
- `ai_type`：AI类型（0=豆包AI, 1=KIMI AI）
- `status`：启用状态

**抓取SQL示例**：
```sql
SELECT * FROM push_order_ai_user 
WHERE product = ? 
  AND status = 0 
  AND user_type = '0'
  AND only_league = true;
```

#### 来源3：2天前推单数据
**查询目的**：用于补单时对比，避免重复推同一赛事给同一用户
**关键SQL**：
```sql
SELECT DISTINCT user_name, league_id, match_id 
FROM push_order_content_management
WHERE product = ? 
  AND league_id IN (?)
  AND DATE(create_time) = CURDATE() - INTERVAL 2 DAY;
```

#### 来源4：赔率数据（Odds）
**格式**：JSON数组
**示例**：
```json
[
  {"handcap": 1.5, "homeOdds": 1.95, "awayOdds": 1.95},
  {"handcap": -1.5, "homeOdds": 1.95, "awayOdds": 1.95},
  {"handcap": 2.5, "homeOdds": 1.95, "awayOdds": 1.95}
]
```
**验证规则**：
- 至少要有3个盘口
- 每个盘口都有 `handcap`、`homeOdds`、`awayOdds`

### 4.2 AI数据抓取来源

#### AI服务集成
**支持的AI**：
1. **豆包AI**（AI类型=0）
   - 实现类：`AIDoubaoServiceImpl`
   - 用途：全AI推单、半AI推单

2. **KIMI AI**（AI类型=1）
   - 实现类：`AIKimiServiceImpl`
   - 用途：全AI推单、半AI推单

**AI调用输入**：
```json
{
  "赛事名称": "曼城 vs 利物浦",
  "联赛": "英超",
  "赛事时间": "2025-02-01 20:00",
  "赔率数据": [...],
  "历史对阵": "历史数据"
}
```

**AI输出格式**：
```json
{
  "标题": "曼城势不可挡 主场看好",
  "分析结果": [
    "进攻能力分析",
    "防守稳定性评估",
    "推荐投注方向"
  ]
}
```

---

## 五、交互接口清单

### 5.1 后台手动控制接口

#### 1. 手动创建推单
**接口路径**：`POST /api/friend/pushOrder/aiUser/backPushOrder`
**功能**：后台人员手动触发推单生成（不等待定时任务）
**请求参数**：
```json
{
  "products": ["yl", "at"]  // 指定产品
}
```
**响应**：
```json
{
  "code": "10000",
  "message": "系统成功",
  "data": {
    "total": 25,  // 生成推单总数
    "details": "推单生成完成"
  }
}
```
**源码位置**：`PushOrderAiUserController.backPushOrder()`

#### 2. 手动创建补单
**接口路径**：`POST /api/friend/pushOrder/aiUser/backRestockPushOrder`
**功能**：后台人员手动触发补单（针对特定联赛）
**请求参数**：
```json
{
  "products": ["yl"]
}
```
**响应**：类同手动创建推单
**源码位置**：`PushOrderAiUserController.backRestockPushOrder()`

#### 3. AI测试接口
**接口路径**：`POST /api/friend/pushOrder/aiUser/testAi`
**功能**：测试AI推单功能，验证AI配置是否正确
**请求参数**：
```json
{
  "matchName": "曼城 vs 利物浦",
  "leagueName": "英超",
  "matchStartTime": "2025-02-01 20:00",
  "odds": "[...]",
  "aiType": 0  // 0=豆包, 1=KIMI
}
```
**响应**：
```json
{
  "code": "10000",
  "data": {
    "标题": "AI生成的标题",
    "分析结果": ["结果1", "结果2", "结果3"]
  }
}
```
**源码位置**：`PushOrderAiUserController.testAi()` → `IAIPushOrderService.testAi()`

---

### 5.2 推单管理接口

#### 4. 推单内容列表（分页）
**接口路径**：`POST /api/friend/pushOrder/contentManagement/pageList`
**功能**：查询所有推单内容，支持筛选和分页
**请求参数**：
```json
{
  "pageNum": 1,
  "pageSize": 20,
  "status": 1,        // 推单状态（0=未发布, 1=已发布）
  "userName": "推单用户名",
  "product": "yl",
  "createTime": "2025-01-30"
}
```
**响应**：
```json
{
  "pageNum": 1,
  "pageSize": 20,
  "total": 100,
  "list": [
    {
      "id": 1,
      "userName": "用户名",
      "matchName": "赛事名",
      "leagueName": "联赛",
      "title": "推单标题",
      "content": "推单分析内容",
      "status": 1,
      "createTime": "2025-01-30 21:00:00"
    }
  ]
}
```

#### 5. 推单内容单条详情
**接口路径**：`POST /api/friend/pushOrder/contentManagement/pageListOne`
**功能**：查询单条推单详情
**请求参数**：
```json
{
  "id": 1,
  "product": "yl"
}
```
**响应**：返回单条推单的完整信息

#### 6. 更新推单
**接口路径**：`POST /api/friend/pushOrder/contentManagement/update`
**功能**：更新推单内容（编辑、发布、下架等）
**请求参数**：
```json
{
  "id": 1,
  "title": "新标题",
  "status": 1,        // 0=未发布, 1=已发布, 2=已完成
  "matchEndTime": "2025-02-01 22:00:00",
  "product": "yl"
}
```

#### 7. 更新推单状态
**接口路径**：`POST /api/friend/pushOrder/contentManagement/updateState`
**功能**：快速更新推单状态（发布/下架/完成）
**请求参数**：
```json
{
  "id": 1,
  "status": 2,  // 目标状态
  "product": "yl"
}
```

---

### 5.3 AI用户管理接口

#### 8. AI推单用户列表
**接口路径**：`POST /api/friend/pushOrder/aiUser/list`
**功能**：查询推单AI用户列表
**请求参数**：
```json
{
  "pageNum": 1,
  "pageSize": 20,
  "product": "yl",
  "userName": "用户名",
  "userType": "0",    // 0=全AI, 1=半AI
  "status": 0
}
```
**响应**：
```json
{
  "list": [
    {
      "id": 1,
      "userName": "大师昵称",
      "userType": "0",
      "product": "yl",
      "aiType": 0,
      "onlyLeague": false,
      "leagueId": null,
      "leagueName": null,
      "status": 0,
      "createTime": "2025-01-01"
    }
  ]
}
```

#### 9. 保存AI推单用户
**接口路径**：`POST /api/friend/pushOrder/aiUser/save`
**功能**：新增推单AI用户
**请求参数**：
```json
{
  "userName": "新用户名",
  "userType": "0",
  "product": "yl",
  "aiType": 0,
  "onlyLeague": false,
  "leagueId": null,
  "status": 0
}
```

#### 10. 更新AI推单用户
**接口路径**：`POST /api/friend/pushOrder/aiUser/update`
**功能**：编辑推单AI用户设置
**请求参数**：
```json
{
  "id": 1,
  "userName": "修改后的名称",
  "onlyLeague": true,
  "leagueId": 1,
  "leagueName": "英超"
}
```

#### 11. 删除AI推单用户
**接口路径**：`POST /api/friend/pushOrder/aiUser/del`
**功能**：删除推单AI用户
**请求参数**：
```json
{
  "id": 1
}
```

---

### 5.4 对外发布接口（无需登录）

#### 12. 查询大师列表
**接口路径**：`POST /api/public/pushOrder/findPersonalInfoPageList`
**功能**：公众查询推单大师列表（按称号：足球大师/篮球大师）
**可访问范围**：公众（无需登录）
**请求参数**：
```json
{
  "pageNum": 1,
  "pageSize": 20,
  "titleLevel": 1,    // 等级
  "matchType": 1      // 1=足球, 2=篮球
}
```

#### 13. 查询大师详情
**接口路径**：`POST /api/public/pushOrder/findMasterDetailed`
**功能**：查询推单大师的详细资料和成绩
**请求参数**：
```json
{
  "userId": 123,
  "matchType": 1
}
```

#### 14. 查询推单用户基本信息
**接口路径**：`POST /api/public/pushOrder/findPushUserInfo`
**功能**：获取推单用户的基本信息（头像、昵称、等级等）
**请求参数**：
```json
{
  "userName": "用户名"
}
```

#### 15. 查询月度排行榜
**接口路径**：`POST /api/public/pushOrder/findMonthlyRankingPageList`
**功能**：查询当月红单榜/连红榜/人气榜
**请求参数**：
```json
{
  "pageNum": 1,
  "pageSize": 20,
  "rankType": "red",    // "red"=红单榜, "redContinue"=连红榜, "hot"=人气榜
  "matchType": 1
}
```

#### 16. 查询方案详情
**接口路径**：`POST /api/public/pushOrder/findPlanDetailed`
**功能**：获取单条推单方案的完整信息
**请求参数**：
```json
{
  "planId": 1,
  "matchType": 1
}
```

#### 17. 查询偏好方案列表
**接口路径**：`POST /api/public/pushOrder/findProgrammePreferredPageList`
**功能**：查询用户收藏/关注的推单方案
**请求参数**：
```json
{
  "userId": 123,
  "pageNum": 1,
  "pageSize": 20
}
```

#### 18. 查询偏好赛事列表
**接口路径**：`POST /api/public/pushOrder/findMatchPreferredPageList`
**功能**：查询用户关注的赛事推单
**请求参数**：
```json
{
  "userId": 123,
  "pageNum": 1,
  "pageSize": 20
}
```

---

### 5.5 参数配置接口

#### 19. 参数配置列表
**接口路径**：`POST /api/friend/pushOrder/paramConfig/list`
**功能**：查询推单系统参数配置
**关键参数**：
- `PUSHORDER_PRODUCT`：推单可用产品列表（逗号分隔，如：`yl,at,qy`）

#### 20. 更新参数配置
**接口路径**：`POST /api/friend/pushOrder/paramConfig/update`
**功能**：修改推单系统参数
**请求参数**：
```json
{
  "code": "PUSHORDER_PRODUCT",
  "value": "yl,at,qy",  // 新产品列表
  "category": "PUSHORDER"
}
```

#### 21. 查询推单价格
**接口路径**：`POST /api/friend/pushOrder/paramConfig/findPushOrdersPrice`
**功能**：获取各产品的推单订阅价格
**响应**：
```json
{
  "yl": 100,
  "at": 200,
  "qy": 150
}
```

---

### 5.6 等级称号配置接口

#### 22. 等级称号列表
**接口路径**：`POST /api/friend/pushOrder/levelTitleConfig/list`
**功能**：查询推单用户的等级和称号配置
**响应**：
```json
{
  "list": [
    {"id": 1, "levelName": "青铜大师", "requiredWins": 10},
    {"id": 2, "levelName": "白银大师", "requiredWins": 50},
    {"id": 3, "levelName": "黄金大师", "requiredWins": 100}
  ]
}
```

#### 23. 新增等级称号
**接口路径**：`POST /api/friend/pushOrder/levelTitleConfig/insert`

#### 24. 更新等级称号
**接口路径**：`POST /api/friend/pushOrder/levelTitleConfig/update`

---

### 5.7 数据统计接口

#### 25. 推单内容通用日志列表
**接口路径**：`POST /api/friend/pushOrder/contentGeneralLog/pageList`
**功能**：查询推单操作日志
**请求参数**：
```json
{
  "pageNum": 1,
  "pageSize": 20,
  "pushOrderId": 1,
  "operationType": "create"  // create/update/delete
}
```

#### 26. 购买统计列表
**接口路径**：`POST /api/friend/pushOrder/contentGeneralLog/purchaseStatisticsPageList`
**功能**：统计推单的购买数据

#### 27. 推单权限记录
**接口路径**：`POST /api/friend/pushOrder/permissionRecord/pageList`
**功能**：查询用户的推单权限操作记录

---

## 六、系统参数配置

### 必需的系统参数

| 参数代码 | 参数类别 | 参数值示例 | 说明 |
|---------|---------|----------|------|
| `PUSHORDER_PRODUCT` | PUSHORDER | `yl,at,qy,e68` | 启用推单的产品列表 |
| `PUSHORDER_SYSTEM_USER` | PUSHORDER | `AI推单大师` | 系统推单用户名（可选） |
| `GRANT_PUSHORDER_AIUSER` | PUSHORDER | `admin,supervisor` | 授权管理推单AI用户的客服名单 |

### 示例配置SQL：
```sql
-- 配置推单产品
INSERT INTO system_parameter (category, code, value, description) 
VALUES ('PUSHORDER', 'PUSHORDER_PRODUCT', 'yl,at,qy,e68', '推单启用产品');

-- 配置授权客服
INSERT INTO system_parameter (category, code, value, description) 
VALUES ('PUSHORDER', 'GRANT_PUSHORDER_AIUSER', 'admin,supervisor', '推单授权客服');
```

---

## 七、关键数据流向图

```
┌─────────────────────────────────────────────────────────────┐
│          定时任务触发（Quartz）                               │
└──────────────┬──────────────────────────────────────────────┘
               │
        ┌──────▼──────┐
        │ 5个定时任务  │
        └──────┬──────┘
               │
    ┌──────────┼──────────┐
    │          │          │
┌───▼──┐   ┌──▼──┐   ┌──▼──┐
│20:00 │   │21:00│   │23:00│  ← 每日执行时间
│真实  │   │全AI │   │补救 │
│推单  │   │推单 │   │推单 │
└──┬───┘   └──┬──┘   └──┬──┘
   │          │        │
   └──────────┼────────┘
              │
        ┌─────▼────────────────┐
        │ 查询数据库            │
        │ 1. 赛事信息(odds)    │
        │ 2. AI用户设置        │
        │ 3. 历史推单记录      │
        └─────┬────────────────┘
              │
        ┌─────▼────────────────┐
        │ 调用AI服务            │
        │ • 豆包AI (0)         │
        │ • KIMI AI (1)        │
        └─────┬────────────────┘
              │
        ┌─────▼────────────────┐
        │ 生成推单内容          │
        │ {标题、分析结果}      │
        └─────┬────────────────┘
              │
        ┌─────▼────────────────┐
        │ 保存到数据库          │
        │ push_order_content   │
        └─────┬────────────────┘
              │
        ┌─────▼────────────────┐
        │ 前端/对外接口         │
        │ • 推单列表           │
        │ • 大师排行榜         │
        │ • 用户订阅           │
        └───────────────────────┘
```

---

## 八、故障排查要点

### 推单不生成的常见原因

| 问题 | 排查方式 | 解决方案 |
|------|---------|---------|
| 没有配置系统参数 | 查询 `system_parameter` 表 `PUSHORDER_PRODUCT` | 添加对应的系统参数 |
| 没有AI推单用户 | 查询 `push_order_ai_user` 表 | 新增推单AI用户 |
| 没有赛事数据 | 查询 `iob_event` 表的未来2天赛事 | 确保赛事数据同步正常 |
| 赔率数据无效 | 检查 `odds` 字段是否为null或[] | 更新赛事数据，补充赔率 |
| AI服务异常 | 查看服务日志，调用测试接口 | 检查豆包/KIMI API配置 |
| 定时任务未启动 | 检查 Tomcat 日志 | 确保 Quartz 配置生效 |

### 查看执行日志

```bash
# 查看推单定时任务日志
tail -f /apache-tomcat-8.5.100/logs/catalina.out | grep -E "AI推单|AI补单|补救推单"

# 查看数据库执行记录
SELECT * FROM push_order_content_management 
WHERE create_time >= CURDATE() 
ORDER BY create_time DESC;
```

---

## 九、性能优化建议

### 当前存在的问题

1. **补单逻辑复杂**：需要多次数据库查询，建议添加缓存
2. **并发性能**：未来赛事多时，查询会很慢，需要索引优化
3. **AI调用成本**：频繁调用AI接口，成本高，可考虑缓存推单模板

### 优化方案

```java
// 1. 添加查询缓存
@Cacheable(value = "aiUserCache", key = "#product")
public List<PushOrderAiUser> getAiUserListByProduct(String product) {...}

// 2. 批量处理赛事
public void batchCreatePushOrder(List<SportMatchVO> matches) {...}

// 3. 异步AI调用
@Async
public void asyncCallAI(SportMatchVO match) {...}
```

### 数据库索引优化

```sql
-- 推荐添加的索引
CREATE INDEX idx_product_status ON push_order_ai_user(product, status);
CREATE INDEX idx_create_time ON push_order_content_management(create_time);
CREATE INDEX idx_match_league ON iob_event(match_id, league_id);
```

---

## 十、总结

**红单功能特点**：
- ✅ 完整的定时任务体系（5个任务）
- ✅ 支持全AI和半AI两种推单模式
- ✅ 联赛级别的精细化管理
- ✅ 丰富的对外发布接口（无需登录）
- ✅ 完善的后台管理和数据统计

**关键指标**：
- **定时任务数**：5个
- **交互接口数**：27个以上
- **支持产品数**：无限制（系统参数配置）
- **AI提供商**：2家（豆包、KIMI）
- **推单模式**：2种（全AI、半AI）

**部署位置**：
- **模块路径**：`DC-API-2018/dc-api/dc-api-office`
- **Controller**：`com.dc.it.friend.controller`
- **Service**：`com.dc.it.friend.service`
- **DAO**：`com.dc.it.friend.dao`
- **Task**：`com.dc.it.friend.quartz.AIPushOrderTask`

