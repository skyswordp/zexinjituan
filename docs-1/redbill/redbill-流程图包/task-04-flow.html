<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>04. æœˆåº¦ç”¨æˆ·ç«æ ‡å¿—è®¾ç½®</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header .task-id {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            margin-right: 10px;
            font-size: 12px;
        }
        
        .header .task-time {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
        }
        
        .header p {
            margin-top: 15px;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .content {
            padding: 40px;
        }
        
        .mermaid {
            display: flex;
            justify-content: center;
            background: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            overflow-x: auto;
        }
        
        .legend {
            margin-top: 30px;
            padding: 20px;
            background: #f5f5f5;
            border-left: 4px solid #667eea;
            border-radius: 5px;
        }
        
        .legend h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            flex-shrink: 0;
        }
        
        .color-green { background: #4CAF50; }
        .color-red { background: #f44336; }
        .color-blue { background: #2196F3; }
        .color-orange { background: #FF9800; }
        .color-yellow { background: #FFC107; }
        .color-purple { background: #9C27B0; }

        .mermaid { max-width: 794px; margin: 0 auto; }
        .mermaid svg { max-width: 100%; height: auto; }

        @page { size: A4 portrait; margin: 12mm; }

        @media print {
            body { background: white; padding: 0; }
            .container { max-width: 794px; border-radius: 0; box-shadow: none; }
            .content { padding: 24px; }
            .mermaid { padding: 12px; }
        }
        
        .footer {
            padding: 20px;
            text-align: center;
            border-top: 1px solid #eee;
            background: #f9f9f9;
            font-size: 12px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 20px;
            }
            
            .content {
                padding: 20px;
            }
            
            .legend-items {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ æœˆåº¦ç”¨æˆ·ç«æ ‡å¿—è®¾ç½®</h1>
            <div>
                <span class="task-id">ä»»åŠ¡ 04</span>
                <span class="task-time">â° æ¯æœˆ5æ—¥ 00:00:00</span>
            </div>
            <p>æ¯æœˆåˆé‡ç½®æ¨å•ç”¨æˆ·çš„ç«æ ‡å¿—å’Œç»Ÿè®¡æ•°æ®</p>
        </div>
        
        <div class="content">
            <div class="mermaid">
graph TD
    START([å®šæ—¶ä»»åŠ¡è§¦å‘<br/>æ¯æœˆ5æ—¥ 00:00:00]) --> LOG1["ğŸ“ è®°å½•æ—¥å¿—<br/>æ¯æœˆåˆè®¾ç½®ç”¨æˆ·ç«æ ‡ å®šæ—¶ä»»åŠ¡ã€å¯åŠ¨ã€‘"]
    
    LOG1 --> CALL_SERVICE["ğŸ”§ è°ƒç”¨IMasterUserService<br/>setUserFire(null)"]
    
    CALL_SERVICE --> CHECK_PARAM{ä¼ å…¥å‚æ•°<br/>ä¸ºnull?}
    
    CHECK_PARAM -->|æ˜¯| PROCESS_ALL["ğŸ”„ å¤„ç†æ‰€æœ‰æ¨å•ç”¨æˆ·<br/>ä¸è¿‡æ»¤ç‰¹å®šæ¡ä»¶"]
    
    CHECK_PARAM -->|å¦| PROCESS_SPECIFIC["ğŸ”„ å¤„ç†ç‰¹å®šç”¨æˆ·<br/>æŒ‰ä¼ å…¥å‚æ•°è¿‡æ»¤"]
    
    PROCESS_ALL --> QUERY_ALL_USERS["ğŸ” æŸ¥è¯¢æ‰€æœ‰æ¨å•ç”¨æˆ·<br/>SELECT * FROM push_order_ai_user"]
    
    PROCESS_SPECIFIC --> QUERY_FILTERED_USERS["ğŸ” æŸ¥è¯¢è¿‡æ»¤åçš„æ¨å•ç”¨æˆ·<br/>æŒ‰å‚æ•°æ¡ä»¶è¿‡æ»¤"]
    
    QUERY_ALL_USERS --> LOOP_USERS["ğŸ”„ å¾ªç¯éå†ç”¨æˆ·åˆ—è¡¨"]
    QUERY_FILTERED_USERS --> LOOP_USERS
    
    LOOP_USERS --> UPDATE_FIRE["ğŸ”¥ æ›´æ–°ç”¨æˆ·ç«æ ‡å¿—<br/>UPDATE push_order_ai_user<br/>SET fire = 1<br/>WHERE id = ?"]
    
    UPDATE_FIRE --> RESET_STATS["ğŸ“Š é‡ç½®ç”¨æˆ·ç»Ÿè®¡æ•°æ®<br/>monthlyWinCount = 0<br/>monthlyHotCount = 0<br/>monthlyRankRing = 0"]
    
    RESET_STATS --> LOG_USER["ğŸ“ è®°å½•æ—¥å¿—<br/>userId: ?<br/>userName: ?, ç«æ ‡å¿—å·²è®¾ç½®"]
    
    LOG_USER --> LOOP_USERS
    
    LOOP_USERS -->|ç»§ç»­| LOOP_USERS
    LOOP_USERS -->|ç»“æŸ| STATS["ğŸ“Š ç»Ÿè®¡æ±‡æ€»<br/>æœ¬æœˆå¤„ç†ç”¨æˆ·æ€»æ•°: N"]
    
    STATS --> LOG_END["ğŸ“ è®°å½•æ—¥å¿—<br/>æ¯æœˆåˆè®¾ç½®ç”¨æˆ·ç«æ ‡ å®šæ—¶ä»»åŠ¡ã€ç»“æŸã€‘<br/>æœ¬æœˆ N ä¸ªç”¨æˆ·ç«æ ‡å·²æ›´æ–°"]
    
    LOG_END --> END([âœ… ä»»åŠ¡å®Œæˆ])
    
    style START fill:#4CAF50,color:#fff
    style END fill:#4CAF50,color:#fff
    style UPDATE_FIRE fill:#FF5722,color:#fff
    style CHECK_PARAM fill:#FFC107,color:#000
    style RESET_STATS fill:#FF9800,color:#fff
    style CALL_SERVICE fill:#2196F3,color:#fff

            </div>
            
            <div class="legend">
                <h3>å›¾ä¾‹è¯´æ˜</h3>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-color color-green"></div>
                        <span>å¼€å§‹/ç»“æŸèŠ‚ç‚¹</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color color-blue"></div>
                        <span>å¤–éƒ¨æœåŠ¡è°ƒç”¨ï¼ˆAIï¼‰</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color color-orange"></div>
                        <span>æ•°æ®åº“æ“ä½œ</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color color-yellow"></div>
                        <span>æ¡ä»¶åˆ¤æ–­</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color color-purple"></div>
                        <span>å¤æ‚ä¸šåŠ¡é€»è¾‘</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color color-red"></div>
                        <span>é”™è¯¯/å¼‚å¸¸å¤„ç†</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>ğŸ’» çº¢å•å®šæ—¶ä»»åŠ¡æµç¨‹å›¾ | ç”Ÿæˆæ—¶é—´: 2026-01-30 | å›¾è¡¨è‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬</p>
        </div>
    </div>
    
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: { useMaxWidth: true }
        });
        mermaid.contentLoaded();
    </script>
</body>
</html>
