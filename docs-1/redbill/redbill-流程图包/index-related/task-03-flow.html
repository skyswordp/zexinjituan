<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>03. AIè¡¥å•ä»»åŠ¡</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header .task-id {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            margin-right: 10px;
            font-size: 12px;
        }
        
        .header .task-time {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
        }
        
        .header p {
            margin-top: 15px;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .content {
            padding: 40px;
        }
        
        .mermaid {
            display: flex;
            justify-content: center;
            background: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            overflow-x: auto;
        }
        
        .legend {
            margin-top: 30px;
            padding: 20px;
            background: #f5f5f5;
            border-left: 4px solid #667eea;
            border-radius: 5px;
        }
        
        .legend h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            flex-shrink: 0;
        }
        
        .color-green { background: #4CAF50; }
        .color-red { background: #f44336; }
        .color-blue { background: #2196F3; }
        .color-orange { background: #FF9800; }
        .color-yellow { background: #FFC107; }
        .color-purple { background: #9C27B0; }

        .mermaid { max-width: 794px; margin: 0 auto; }
        .mermaid svg { max-width: 100%; height: auto; }

        @page { size: A4 portrait; margin: 12mm; }

        @media print {
            body { background: white; padding: 0; }
            .container { max-width: 794px; border-radius: 0; box-shadow: none; }
            .content { padding: 24px; }
            .mermaid { padding: 12px; }
        }
        
        .footer {
            padding: 20px;
            text-align: center;
            border-top: 1px solid #eee;
            background: #f9f9f9;
            font-size: 12px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 20px;
            }
            
            .content {
                padding: 20px;
            }
            
            .legend-items {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ AIè¡¥å•ä»»åŠ¡</h1>
            <div>
                <span class="task-id">ä»»åŠ¡ 03</span>
                <span class="task-time">â° 00:00:01</span>
            </div>
            <p>ä¸ºé’ˆå¯¹ç‰¹å®šè”èµ›çš„æ¨å•ç”¨æˆ·è¡¥å……æ¨å•</p>
        </div>
        
        <div class="content">
            <div class="mermaid">
graph TD
    START([å®šæ—¶ä»»åŠ¡è§¦å‘<br/>00:00:01]) --> LOG1["ğŸ“ è®°å½•æ—¥å¿—<br/>AIè¡¥å• å®šæ—¶ä»»åŠ¡ã€å¯åŠ¨ã€‘"]
    
    LOG1 --> GET_PRODUCTS["ğŸ” è·å–ç³»ç»Ÿå‚æ•°<br/>PUSHORDER_PRODUCT<br/>è·å–æ¨å•äº§å“åˆ—è¡¨"]
    
    GET_PRODUCTS --> CHECK_PRODUCTS{äº§å“åˆ—è¡¨<br/>æ˜¯å¦å­˜åœ¨?}
    
    CHECK_PRODUCTS -->|å¦| ERROR1["âŒ è®°å½•é”™è¯¯<br/>æ²¡æœ‰é…ç½®PUSHORDER_PRODUCT<br/>ç³»ç»Ÿå‚æ•°<br/>ã€è¢«è¿«ç»“æŸã€‘"]
    
    CHECK_PRODUCTS -->|æ˜¯| LOOP_PRODUCTS["ğŸ”„ å¾ªç¯äº§å“åˆ—è¡¨"]
    
    LOOP_PRODUCTS --> QUERY_LEAGUE_USERS["ğŸ” æŸ¥è¯¢é’ˆå¯¹è”èµ›çš„AIç”¨æˆ·<br/>product = ?<br/>status = 0<br/>userType = '0'<br/>onlyLeague = true"]
    
    QUERY_LEAGUE_USERS --> CHECK_LEAGUE_USERS{æŸ¥è¯¢åˆ°<br/>è”èµ›é™åˆ¶ç”¨æˆ·?}
    
    CHECK_LEAGUE_USERS -->|å¦| SKIP_PRODUCT["â­ï¸ è·³è¿‡æ­¤äº§å“<br/>ğŸ“ è®°å½•æ—¥å¿—"]
    
    CHECK_LEAGUE_USERS -->|æ˜¯| EXTRACT_LEAGUES["ğŸ“Š æå–è”èµ›IDåˆ—è¡¨<br/>DISTINCT leagueId"]
    
    EXTRACT_LEAGUES --> QUERY_2DAYS_AGO["ğŸ” æŸ¥è¯¢2å¤©å‰æ¨è¿‡çš„èµ›äº‹<br/>WHERE product = ?<br/>AND leagueId IN (...)<br/>AND DATE(create_time) = CURDATE-2"]
    
    QUERY_2DAYS_AGO --> BUILD_MAP["ğŸ—ºï¸ æ„å»ºæ¨å•æ•°é‡ç»Ÿè®¡è¡¨<br/>Key: userName<br/>Value: pushOrderCount<br/>ç»Ÿè®¡2å¤©å‰æ¯ä¸ªç”¨æˆ·çš„æ¨å•æ•°"]
    
    BUILD_MAP --> QUERY_TODAY_RESTOCK["ğŸ” æŸ¥è¯¢å½“æ—¥ç‰¹å®šè”èµ›<br/>æœªæ¨è¿‡çš„èµ›äº‹<br/>WHERE match NOT IN 2DaysAgoMatches<br/>AND matchType IN leagues"]
    
    QUERY_TODAY_RESTOCK --> CHECK_RESTOCK{æŸ¥è¯¢åˆ°<br/>æœªæ¨èµ›äº‹?}
    
    CHECK_RESTOCK -->|å¦| SKIP_PRODUCT
    
    CHECK_RESTOCK -->|æ˜¯| FILTER_ODDS["ğŸ” ç¬¬1æ­¥è¿‡æ»¤<br/>æ’é™¤ odds = null<br/>æ’é™¤ odds = []"]
    
    FILTER_ODDS --> CHECK_ODDS1{æœ‰æ•ˆ<br/>èµ›äº‹æ•°?}
    
    CHECK_ODDS1 -->|å¦| SKIP_PRODUCT
    CHECK_ODDS1 -->|æ˜¯| FILTER_ODDS_COUNT["ğŸ” ç¬¬2æ­¥è¿‡æ»¤<br/>æ’é™¤ odds ä¸­ç›˜å£<br/>ä¸è¶³3ä¸ªçš„èµ›äº‹<br/>å¿…é¡» odds.length = 3"]
    
    FILTER_ODDS_COUNT --> CHECK_ODDS2{æœ‰æ•ˆ<br/>èµ›äº‹æ•°?}
    
    CHECK_ODDS2 -->|å¦| SKIP_PRODUCT
    CHECK_ODDS2 -->|æ˜¯| DEDUCT_COUNT["ğŸ”¢ æ‰£å‡æ¨å•æ•°é‡<br/>å¯¹äº2å¤©å‰æ¨è¿‡çš„ç”¨æˆ·<br/>æŒ‰leagueIdåŒ¹é…<br/>å‡å»ç»Ÿè®¡è¡¨ä¸­çš„æ•°é‡"]
    
    DEDUCT_COUNT --> LOOP_USERS["ğŸ”„ å¾ªç¯å¤„ç†ç”¨æˆ·<br/>æŒ‰å‰©ä½™æ¨å•æ•°ç”Ÿæˆ"]
    
    LOOP_USERS --> LOOP_MATCHES["ğŸ”„ å¾ªç¯èµ›äº‹åˆ—è¡¨"]
    
    LOOP_MATCHES --> CHECK_USER_LIMIT{æ£€æŸ¥ç”¨æˆ·<br/>å‰©ä½™æ¨å•æ•°<br/>æ˜¯å¦>0?}
    
    CHECK_USER_LIMIT -->|å¦| SKIP_USER["â­ï¸ è·³è¿‡è¯¥ç”¨æˆ·<br/>å·²ç”¨å®Œæ¨å•æ•°"]
    CHECK_USER_LIMIT -->|æ˜¯| CALL_AI["ğŸ¤– è°ƒç”¨AIæ¥å£<br/>AIç±»å‹: è±†åŒ…/KIMI<br/>è¾“å…¥: èµ›äº‹+èµ”ç‡+å†å²æ•°æ®"]
    
    CALL_AI --> CHECK_AI{AIè°ƒç”¨<br/>æˆåŠŸ?}
    
    CHECK_AI -->|å¦| LOG_AI_ERROR["ğŸ“ è®°å½•AIè°ƒç”¨å¤±è´¥<br/>ç»§ç»­ä¸‹ä¸€æ¡èµ›äº‹"]
    CHECK_AI -->|æ˜¯| PARSE_AI_RESULT["ğŸ“Š è§£æAIç»“æœ<br/>{æ ‡é¢˜, åˆ†æç»“æœ[]}"]
    
    LOG_AI_ERROR --> LOOP_MATCHES
    
    PARSE_AI_RESULT --> SAVE_DB["ğŸ’¾ ä¿å­˜è¡¥å•å†…å®¹<br/>INSERT push_order_content<br/>pushOrderType = 'restock'"]
    
    SAVE_DB --> DEDUCT_USER_COUNT["ğŸ”¢ å‡å°‘ç”¨æˆ·å‰©ä½™æ¨å•æ•°<br/>userRestockCount--"]
    
    DEDUCT_USER_COUNT --> UPDATE_SUCCESS_COUNT["ğŸ”¢ æ›´æ–°è¡¥å•è®¡æ•°<br/>successTotal++"]
    
    UPDATE_SUCCESS_COUNT --> LOOP_MATCHES
    
    SKIP_USER --> LOOP_MATCHES
    
    LOOP_MATCHES -->|ç»§ç»­| LOOP_MATCHES
    LOOP_MATCHES -->|ç»“æŸ| LOOP_USERS
    
    LOOP_USERS -->|ç»§ç»­| LOOP_USERS
    LOOP_USERS -->|ç»“æŸ| SKIP_PRODUCT
    
    SKIP_PRODUCT -->|ç»§ç»­| LOOP_PRODUCTS
    SKIP_PRODUCT -->|ç»“æŸ| STATS["ğŸ“Š ç»Ÿè®¡æ±‡æ€»<br/>å…¨éƒ¨äº§å“è¡¥å•æ€»æ•°: successTotal"]
    
    STATS --> LOG_END["ğŸ“ è®°å½•æ—¥å¿—<br/>AIè¡¥å• å®šæ—¶ä»»åŠ¡ã€ç»“æŸã€‘<br/>æœ¬æ¬¡è¡¥å•ç”Ÿæˆ N å•æ¨å•"]
    
    LOG_END --> END([âœ… ä»»åŠ¡å®Œæˆ])
    
    ERROR1 --> END_ERROR([âŒ ä»»åŠ¡å¤±è´¥])
    
    style START fill:#4CAF50,color:#fff
    style END fill:#4CAF50,color:#fff
    style END_ERROR fill:#f44336,color:#fff
    style ERROR1 fill:#f44336,color:#fff
    style CALL_AI fill:#2196F3,color:#fff
    style SAVE_DB fill:#FF9800,color:#fff
    style CHECK_PRODUCTS fill:#FFC107,color:#000
    style CHECK_LEAGUE_USERS fill:#FFC107,color:#000
    style CHECK_RESTOCK fill:#FFC107,color:#000
    style CHECK_ODDS1 fill:#FFC107,color:#000
    style CHECK_ODDS2 fill:#FFC107,color:#000
    style CHECK_USER_LIMIT fill:#FFC107,color:#000
    style CHECK_AI fill:#FFC107,color:#000
    style EXTRACT_LEAGUES fill:#9C27B0,color:#fff
    style BUILD_MAP fill:#9C27B0,color:#fff
    style DEDUCT_COUNT fill:#9C27B0,color:#fff

            </div>
            
            <div class="legend">
                <h3>å›¾ä¾‹è¯´æ˜</h3>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-color color-green"></div>
                        <span>å¼€å§‹/ç»“æŸèŠ‚ç‚¹</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color color-blue"></div>
                        <span>å¤–éƒ¨æœåŠ¡è°ƒç”¨ï¼ˆAIï¼‰</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color color-orange"></div>
                        <span>æ•°æ®åº“æ“ä½œ</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color color-yellow"></div>
                        <span>æ¡ä»¶åˆ¤æ–­</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color color-purple"></div>
                        <span>å¤æ‚ä¸šåŠ¡é€»è¾‘</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color color-red"></div>
                        <span>é”™è¯¯/å¼‚å¸¸å¤„ç†</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>ğŸ’» çº¢å•å®šæ—¶ä»»åŠ¡æµç¨‹å›¾ | ç”Ÿæˆæ—¶é—´: 2026-01-30 | å›¾è¡¨è‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬</p>
        </div>
    </div>
    
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: { useMaxWidth: true }
        });
        mermaid.contentLoaded();
    </script>
</body>
</html>
