# æ–‡ä»¶ä¸Šä¼ ä¿®å¤ - éƒ¨ç½²è¯´æ˜

## âœ… ä»£ç ä¿®æ”¹å®Œæˆ

**ä¿®æ”¹æ–‡ä»¶**ï¼š`dc-parent/dc-api-web/src/main/java/com/dc/it/controller/FriendController.java`

**ä¿®æ”¹ä½ç½®**ï¼šç¬¬754-786è¡Œï¼ˆuploadæ–¹æ³•ï¼‰

**ä¿®æ”¹å†…å®¹**ï¼šä¸ºmultipartè¯·æ±‚æ·»åŠ å‚æ•°æå–é€»è¾‘

---

## ğŸ”§ ä¿®æ”¹è¯¦æƒ…

### åŸä»£ç ï¼ˆ3è¡Œï¼‰
```java
@RequestMapping(value = "/upload/1.0/upload", method = RequestMethod.POST, produces = MediaType.APPLICATION_JSON_VALUE + Common.METHOD_CHARSET)
public String upload(MultipartFile[] files, HttpServletRequest request, HttpSession httpSession) {
    return forwardToFriendApiUpload(request, files, "/api/friend/upload/1.0/upload", "upload");
}
```

### æ–°ä»£ç ï¼ˆ33è¡Œï¼‰
```java
@RequestMapping(value = "/upload/1.0/upload", method = RequestMethod.POST, produces = MediaType.APPLICATION_JSON_VALUE + Common.METHOD_CHARSET)
public String upload(MultipartFile[] files, HttpServletRequest request, HttpSession httpSession) {
    // multipartè¯·æ±‚ç‰¹æ®Šå¤„ç†ï¼šä»URLå‚æ•°æˆ–è¡¨å•å­—æ®µæå–å‚æ•°
    // å› ä¸ºmultipartæ²¡æœ‰JSON bodyï¼ŒSessionTimeoutInterceptoræ— æ³•è®¾ç½®paramJson
    if (request.getContentType() != null && request.getContentType().contains("multipart/form-data")) {
        JSONObject params = (JSONObject) request.getAttribute("paramJson");
        if (params == null) {
            params = new JSONObject();
        }
        
        // ä»è¯·æ±‚å‚æ•°ä¸­æå–æ‰€æœ‰å­—æ®µï¼ˆåŒ…æ‹¬URLå‚æ•°å’Œè¡¨å•å­—æ®µï¼‰
        java.util.Enumeration<String> paramNames = request.getParameterNames();
        while (paramNames.hasMoreElements()) {
            String name = paramNames.nextElement();
            String value = request.getParameter(name);
            if (StringUtils.isNotBlank(value)) {
                params.put(name, value);
            }
        }
        
        // å¦‚æœæ²¡æœ‰productå‚æ•°ï¼Œä½¿ç”¨é»˜è®¤å€¼
        if (!params.containsKey("product") || StringUtils.isBlank(params.getString("product"))) {
            params.put("product", PRODUCT);
        }
        
        request.setAttribute("paramJson", params);
    }
    
    return forwardToFriendApiUpload(request, files, "/api/friend/upload/1.0/upload", "upload");
}
```

---

## ğŸ¯ è§£å†³çš„é—®é¢˜

### ä¹‹å‰çš„é”™è¯¯
```
å“åº”ç : 116
æ¶ˆæ¯: è¯·æ±‚å‚æ•°ä¸èƒ½ä¸ºç©º[traceId]
```

### æ ¹æœ¬åŸå› 
multipart/form-dataè¯·æ±‚æ²¡æœ‰JSON bodyï¼Œå¯¼è‡´ï¼š
1. SessionTimeoutInterceptoræ— æ³•ä»request bodyè§£æå‚æ•°
2. paramJson attributeæœªè¢«è®¾ç½®
3. getRequestData(request) è¿”å›null
4. forwardToFriendApiUploadä¸­frontendParamsä¸ºç©ºï¼ŒæŠ›å‡ºé”™è¯¯

### ä¿®å¤æ–¹æ¡ˆ
åœ¨upload()æ–¹æ³•ä¸­ï¼š
1. æ£€æµ‹multipartè¯·æ±‚
2. æ‰‹åŠ¨ä»request.getParameter()æå–URLå‚æ•°å’Œè¡¨å•å­—æ®µ
3. è®¾ç½®paramJson attribute
4. ä¿è¯forwardToFriendApiUploadèƒ½è·å–åˆ°å‚æ•°

---

## ğŸ“¦ éƒ¨ç½²æ­¥éª¤

### æ–¹å¼1ï¼šæ‰‹åŠ¨ç¼–è¯‘éƒ¨ç½²ï¼ˆæ¨èï¼‰

1. **ç¼–è¯‘é¡¹ç›®**
   ```bash
   cd c:\Users\DEVTrump\projects\dc-parent
   mvn clean package -DskipTests -pl dc-api-web -am
   ```
   
   æ³¨æ„ï¼šå¦‚æœé‡åˆ°tools.jarè·¯å¾„é”™è¯¯ï¼Œéœ€å…ˆä¿®å¤pom.xml

2. **å¤åˆ¶WARåŒ…åˆ°Tomcat**
   ```bash
   copy dc-api-web\target\dc-api-web.war C:\apache-tomcat-8.5.100\webapps\
   ```

3. **é‡å¯Tomcat**
   ```bash
   C:\apache-tomcat-8.5.100\bin\shutdown.bat
   C:\apache-tomcat-8.5.100\bin\startup.bat
   ```

4. **éªŒè¯éƒ¨ç½²**
   ```bash
   # æŸ¥çœ‹æ—¥å¿—
   Get-Content C:\apache-tomcat-8.5.100\logs\catalina.out -Tail 50 -Wait
   ```

### æ–¹å¼2ï¼šçƒ­éƒ¨ç½²ï¼ˆå¦‚æœæ”¯æŒï¼‰

```bash
# åªç¼–è¯‘ç±»æ–‡ä»¶
mvn compile -pl dc-api-web

# å¤åˆ¶åˆ°è¿è¡Œæ—¶ç›®å½•
copy dc-api-web\target\classes\com\dc\it\controller\FriendController.class ^
     C:\apache-tomcat-8.5.100\webapps\dc-api-web\WEB-INF\classes\com\dc\it\controller\
```

### æ–¹å¼3ï¼šç­‰å¾…è‡ªåŠ¨éƒ¨ç½²

å¦‚æœæœ‰CI/CDæµç¨‹ï¼Œæäº¤ä»£ç åç­‰å¾…è‡ªåŠ¨éƒ¨ç½²ã€‚

---

## âœ… éªŒè¯æµ‹è¯•

éƒ¨ç½²å®Œæˆåï¼Œè¿è¡Œæµ‹è¯•è„šæœ¬ï¼š

```bash
cd c:\Users\DEVTrump\projects\docs-1\FriendController
python test_api.py
```

**é¢„æœŸç»“æœ**ï¼š
```
[ 1/23] 1. getUser ... âœ… PASS
...
[22/23] 22. æ–‡ä»¶ä¸Šä¼  - å›¾ç‰‡ ... âœ… PASS  â† è¿™ä¸ªåº”è¯¥é€šè¿‡äº†ï¼
[23/23] 23. æ–‡ä»¶ä¸Šä¼  - è§†é¢‘ ... âœ… PASS  â† è¿™ä¸ªåº”è¯¥é€šè¿‡äº†ï¼

æ€»è®¡: 23 | âœ… é€šè¿‡: 23 | âŒ å¤±è´¥: 0 | æˆåŠŸç‡: 100%
```

---

## ğŸ§ª å•ç‹¬æµ‹è¯•ä¸Šä¼ æ¥å£

å¦‚æœæƒ³å•ç‹¬æµ‹è¯•ä¸Šä¼ åŠŸèƒ½ï¼š

```bash
# PowerShell
$boundary = "----WebKitFormBoundary7MA4YWxkTrZu0gW"
$body = @"
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="file"; filename="test.png"
Content-Type: image/png

<äºŒè¿›åˆ¶æ•°æ®>
------WebKitFormBoundary7MA4YWxkTrZu0gW--
"@

Invoke-WebRequest -Uri "https://e68web01.itomtest.com/api/friend/upload/1.0/upload?product=yl" `
  -Method POST `
  -Headers @{
    "Cookie" = "__snaker__id=jvOJbjKJWgJZ7mEl; JSESSIONID=E85595B704A736F259DBA0CAC72DCF0C"
    "Content-Type" = "multipart/form-data; boundary=$boundary"
  } `
  -Body $body
```

æˆ–ä½¿ç”¨curlï¼š
```bash
curl.exe -X POST "https://e68web01.itomtest.com/api/friend/upload/1.0/upload?product=yl" \
  -H "Cookie: __snaker__id=jvOJbjKJWgJZ7mEl; JSESSIONID=E85595B704A736F259DBA0CAC72DCF0C" \
  -F "file=@test_image.png"
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### å¦‚æœä»ç„¶å¤±è´¥

1. **æ£€æŸ¥æ—¥å¿—**
   ```bash
   Get-Content C:\apache-tomcat-8.5.100\logs\tomcat-console.log -Tail 100 | Select-String "upload|multipart|paramJson"
   ```

2. **éªŒè¯ä»£ç å·²éƒ¨ç½²**
   ```bash
   # æŸ¥çœ‹classæ–‡ä»¶æ—¶é—´æˆ³
   Get-Item C:\apache-tomcat-8.5.100\webapps\dc-api-web\WEB-INF\classes\com\dc\it\controller\FriendController.class | Select-Object LastWriteTime
   ```

3. **æ£€æŸ¥productå‚æ•°**
   - URLå‚æ•°ï¼š`/upload/1.0/upload?product=yl`
   - è¡¨å•å­—æ®µï¼š`data={'product': 'yl'}`
   - ä¸¤è€…ä»»é€‰å…¶ä¸€å³å¯

4. **æ£€æŸ¥å“åº”ç **
   - 116 = å‚æ•°ä¸ºç©ºï¼ˆä¿®å¤æœªç”Ÿæ•ˆï¼‰
   - 10000 = æˆåŠŸ
   - 10001 = ä¸šåŠ¡å¤±è´¥ï¼ˆæ£€æŸ¥æ–‡ä»¶æ ¼å¼ã€å¤§å°é™åˆ¶ç­‰ï¼‰

---

## ğŸ“Š å½±å“èŒƒå›´

- âœ… **åªå½±å“æ–‡ä»¶ä¸Šä¼ æ¥å£** - å…¶ä»–21ä¸ªJSONæ¥å£ä¸å—å½±å“
- âœ… **å‘åå…¼å®¹** - å¦‚æœparamJsonå·²è®¾ç½®ï¼Œä¸ä¼šè¦†ç›–
- âœ… **æ”¯æŒå¤šç§å‚æ•°ä¼ é€’æ–¹å¼**ï¼š
  - URLå‚æ•°ï¼š`?product=yl`
  - è¡¨å•å­—æ®µï¼š`product=yl`ï¼ˆä½œä¸ºmultipart fieldï¼‰
  - æ··åˆä½¿ç”¨ï¼ˆä¼˜å…ˆä½¿ç”¨request.getParameter()è·å–çš„å€¼ï¼‰

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

å¦‚æœæœ‰æ›´å¤šæ–‡ä»¶ä¸Šä¼ æ¥å£ï¼Œå¯ä»¥è€ƒè™‘ï¼š

1. **æŠ½å–å…¬å…±æ–¹æ³•**
   ```java
   protected void ensureParamJsonForMultipart(HttpServletRequest request) {
       if (request.getContentType() != null && request.getContentType().contains("multipart/form-data")) {
           // ... å‚æ•°æå–é€»è¾‘
       }
   }
   ```

2. **åœ¨BaseControllerä¸­ç»Ÿä¸€å¤„ç†**
   è®©æ‰€æœ‰ç»§æ‰¿BaseControllerçš„ç±»è‡ªåŠ¨æ”¯æŒ

3. **åœ¨æ‹¦æˆªå™¨ä¸­ç»Ÿä¸€å¤„ç†**
   ä¿®æ”¹SessionTimeoutInterceptoræ”¯æŒmultipart

å½“å‰æ–¹æ¡ˆå¿«é€Ÿæœ‰æ•ˆï¼Œè¶³å¤Ÿè§£å†³é—®é¢˜ï¼ğŸ‰
